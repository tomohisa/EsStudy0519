# å€‰åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚·ãƒ³ã‚°ãƒ¢ãƒ‡ãƒ«å®Ÿè£…è¨ˆç”»

**ãƒ¢ãƒ‡ãƒ«ï¼š** GitHub Copilot

## æ¦‚è¦
å€‰åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚·ãƒ³ã‚°ãƒ¢ãƒ‡ãƒ«ã‚’EsStudy0519.Domainãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…ã«Sekibanã‚’ä½¿ç”¨ã—ã¦å®Ÿè£…ã—ã¾ã™ã€‚

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ

### ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆï¼šInventoryItem
å€‰åº«å†…ã®å•†å“åœ¨åº«ã‚’è¡¨ã™ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆã§ã€å…¥åº«ã€å‡ºåº«ã€äºˆç´„ãªã©ã®æ©Ÿèƒ½ã‚’æŒã¡ã¾ã™ã€‚

### ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«çŠ¶æ…‹
1. **ActiveInventryItem**ï¼šå…¥åº«äºˆç´„ã€å‡ºåº«äºˆç´„ã€å…¥åº«ã€å‡ºåº«å¯èƒ½
2. **RetiredInventryItem**ï¼šå‡ºåº«äºˆç´„ã€å‡ºåº«å¯èƒ½ï¼ˆå…¥åº«äºˆç´„ã€å…¥åº«ã¯ä¸å¯èƒ½ï¼‰
3. **DisabledInventryItem**ï¼šäºˆç´„ã€å…¥åº«ã€å‡ºåº«ä¸å¯èƒ½

## å®Ÿè£…è¨ˆç”»

### 1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ 
```
EsStudy0519.Domain/
  â””â”€â”€ Aggregates/
      â””â”€â”€ InventoryItems/
          â”œâ”€â”€ InventoryItemProjector.cs
          â”œâ”€â”€ Payloads/
          â”‚   â”œâ”€â”€ ActiveInventoryItem.cs
          â”‚   â”œâ”€â”€ RetiredInventoryItem.cs
          â”‚   â””â”€â”€ DisabledInventoryItem.cs
          â”œâ”€â”€ Events/
          â”‚   â”œâ”€â”€ InventryItemCreated.cs
          â”‚   â”œâ”€â”€ GoodsReceived.cs
          â”‚   â”œâ”€â”€ GoodsShipped.cs
          â”‚   â”œâ”€â”€ IncomingStockReserved.cs
          â”‚   â”œâ”€â”€ OutgoingStockReserved.cs
          â”‚   â”œâ”€â”€ ReservationCancelled.cs
          â”‚   â”œâ”€â”€ GoodsReturned.cs
          â”‚   â”œâ”€â”€ InventryItemRetired.cs
          â”‚   â””â”€â”€ InventryItemDisabled.cs
          â”œâ”€â”€ Commands/
          â”‚   â”œâ”€â”€ CreateInventoryItemCommand.cs
          â”‚   â”œâ”€â”€ ReceiveGoodsCommand.cs
          â”‚   â”œâ”€â”€ ShipGoodsCommand.cs
          â”‚   â”œâ”€â”€ ReserveIncomingStockCommand.cs
          â”‚   â”œâ”€â”€ ReserveOutgoingStockCommand.cs
          â”‚   â”œâ”€â”€ CancelReservationCommand.cs
          â”‚   â”œâ”€â”€ ReturnGoodsCommand.cs
          â”‚   â”œâ”€â”€ RetireInventoryItemCommand.cs
          â”‚   â””â”€â”€ DisableInventoryItemCommand.cs
          â””â”€â”€ Queries/
              â””â”€â”€ InventoryItemListQuery.cs
```

### 2. å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
å¿…è¦ã«å¿œã˜ã¦ä»¥ä¸‹ã®å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™ï¼š
- `ReservationId` - äºˆç´„ã‚’ä¸€æ„ã«è­˜åˆ¥ã™ã‚‹å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
- `Quantity` - æ•°é‡ã‚’è¡¨ã™å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆãƒã‚¤ãƒŠã‚¹ã®å€¤ã‚’ã¨ã‚Œãªã„ã‚ˆã†ã«åˆ¶ç´„ã‚’ã‹ã‘ã‚‹ï¼‰
- `Reason` - è¿”å“ç†ç”±ã‚’è¡¨ã™å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ

### 3. Payloadsã®å®Ÿè£…

#### ActiveInventoryItem
```csharp
[GenerateSerializer]
public record ActiveInventoryItem(
    string ProductId,
    string WarehouseId,
    string ProductName,
    int StockQuantity,
    Dictionary<Guid, ReservationInfo> IncomingReservations,
    Dictionary<Guid, ReservationInfo> OutgoingReservations,
    DateTime CreatedAt
) : IAggregatePayload;
```

#### RetiredInventoryItem
```csharp
[GenerateSerializer]
public record RetiredInventoryItem(
    string ProductId,
    string WarehouseId,
    string ProductName,
    int StockQuantity,
    Dictionary<Guid, ReservationInfo> OutgoingReservations,
    DateTime CreatedAt,
    DateTime RetiredAt
) : IAggregatePayload;
```

#### DisabledInventoryItem
```csharp
[GenerateSerializer]
public record DisabledInventoryItem(
    string ProductId,
    string WarehouseId,
    string ProductName,
    int StockQuantity,
    DateTime CreatedAt,
    DateTime DisabledAt
) : IAggregatePayload;
```

#### ReservationInfoï¼ˆè£œåŠ©ã‚¯ãƒ©ã‚¹ï¼‰
```csharp
[GenerateSerializer]
public record ReservationInfo(
    Guid ReservationId,
    int Quantity,
    DateTime ReservedAt
);
```

### 4. Eventsã®å®Ÿè£…

#### InventryItemCreated
```csharp
[GenerateSerializer]
public record InventryItemCreated(
    string ProductId, 
    string WarehouseId, 
    string ProductName
) : IEventPayload;
```

#### GoodsReceived
```csharp
[GenerateSerializer]
public record GoodsReceived(
    string ProductId,
    int Quantity,
    DateTime ReceivedDate
) : IEventPayload;
```

#### GoodsShipped
```csharp
[GenerateSerializer]
public record GoodsShipped(
    string ProductId,
    int Quantity,
    DateTime ShippedDate
) : IEventPayload;
```

#### IncomingStockReserved
```csharp
[GenerateSerializer]
public record IncomingStockReserved(
    string ProductId,
    int Quantity,
    Guid ReservationId,
    DateTime ReservationDate
) : IEventPayload;
```

#### OutgoingStockReserved
```csharp
[GenerateSerializer]
public record OutgoingStockReserved(
    string ProductId,
    int Quantity,
    Guid ReservationId,
    DateTime ReservationDate
) : IEventPayload;
```

#### ReservationCancelled
```csharp
[GenerateSerializer]
public record ReservationCancelled(
    string ProductId,
    Guid ReservationId,
    DateTime CancellationDate
) : IEventPayload;
```

#### GoodsReturned
```csharp
[GenerateSerializer]
public record GoodsReturned(
    string ProductId,
    int Quantity,
    string Reason,
    DateTime ReturnDate
) : IEventPayload;
```

#### InventryItemRetired
```csharp
[GenerateSerializer]
public record InventryItemRetired(
    string ProductId,
    DateTime RetiredDate
) : IEventPayload;
```

#### InventryItemDisabled
```csharp
[GenerateSerializer]
public record InventryItemDisabled(
    string ProductId,
    DateTime DisabledDate
) : IEventPayload;
```

### 5. Commandsã®å®Ÿè£…

#### CreateInventoryItemCommand
```csharp
[GenerateSerializer]
public record CreateInventoryItemCommand(
    string ProductId,
    string WarehouseId,
    string ProductName
) : ICommandWithHandler<CreateInventoryItemCommand, InventoryItemProjector>
{
    public PartitionKeys SpecifyPartitionKeys(CreateInventoryItemCommand command) =>
        PartitionKeys.Generate<InventoryItemProjector>();

    public ResultBox<EventOrNone> Handle(CreateInventoryItemCommand command, ICommandContext<IAggregatePayload> context)
        => EventOrNone.Event(new InventryItemCreated(command.ProductId, command.WarehouseId, command.ProductName));
}
```

#### ReceiveGoodsCommand
```csharp
[GenerateSerializer]
public record ReceiveGoodsCommand(
    Guid AggregateId,
    string ProductId,
    int Quantity,
    DateTime ReceivedDate
) : ICommandWithHandler<ReceiveGoodsCommand, InventoryItemProjector, ActiveInventoryItem>
{
    public PartitionKeys SpecifyPartitionKeys(ReceiveGoodsCommand command) =>
        PartitionKeys.Existing<InventoryItemProjector>(command.AggregateId);

    public ResultBox<EventOrNone> Handle(ReceiveGoodsCommand command, ICommandContext<ActiveInventoryItem> context)
    {
        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼šæ•°é‡ã¯æ­£ã®å€¤ã§ã‚ã‚‹ã“ã¨
        if (command.Quantity <= 0)
        {
            return new ArgumentException("Quantity must be positive");
        }
        
        return EventOrNone.Event(new GoodsReceived(command.ProductId, command.Quantity, command.ReceivedDate));
    }
}
```

ä»¥ä¸‹åŒæ§˜ã«ã€å„ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè£…ã—ã¾ã™ã€‚å„ã‚³ãƒãƒ³ãƒ‰ã§ã¯ã€é©åˆ‡ãªçŠ¶æ…‹ï¼ˆActiveInventoryItemã€RetiredInventoryItemã€DisabledInventoryItemï¼‰ã«å¯¾ã™ã‚‹åˆ¶ç´„ã‚’è¨­ã‘ã€çŠ¶æ…‹ã«å¿œã˜ãŸæ“ä½œã‚’è¨±å¯ã¾ãŸã¯åˆ¶é™ã—ã¾ã™ã€‚

### 6. Projectorã®å®Ÿè£…

```csharp
public class InventoryItemProjector : IAggregateProjector
{
    public IAggregatePayload Project(IAggregatePayload payload, IEvent ev)
        => (payload, ev.GetPayload()) switch
        {
            // æ–°è¦ä½œæˆ
            (EmptyAggregatePayload, InventryItemCreated e) => new ActiveInventoryItem(
                e.ProductId,
                e.WarehouseId,
                e.ProductName,
                0, // åˆæœŸåœ¨åº«ãªã—
                new Dictionary<Guid, ReservationInfo>(),
                new Dictionary<Guid, ReservationInfo>(),
                DateTime.UtcNow),
                
            // ActiveInventoryItemã®çŠ¶æ…‹é·ç§»
            (ActiveInventoryItem item, GoodsReceived e) => item with { 
                StockQuantity = item.StockQuantity + e.Quantity 
            },
            
            (ActiveInventoryItem item, GoodsShipped e) => item with { 
                StockQuantity = item.StockQuantity - e.Quantity 
            },
            
            (ActiveInventoryItem item, IncomingStockReserved e) => HandleIncomingReservation(item, e),
            
            (ActiveInventoryItem item, OutgoingStockReserved e) => HandleOutgoingReservation(item, e),
            
            (ActiveInventoryItem item, ReservationCancelled e) => HandleReservationCancellation(item, e),
            
            (ActiveInventoryItem item, GoodsReturned e) => item with { 
                StockQuantity = item.StockQuantity + e.Quantity 
            },
            
            (ActiveInventoryItem item, InventryItemRetired e) => new RetiredInventoryItem(
                item.ProductId,
                item.WarehouseId,
                item.ProductName,
                item.StockQuantity,
                item.OutgoingReservations,
                item.CreatedAt,
                e.RetiredDate),
                
            (ActiveInventoryItem item, InventryItemDisabled e) => new DisabledInventoryItem(
                item.ProductId,
                item.WarehouseId,
                item.ProductName,
                item.StockQuantity,
                item.CreatedAt,
                e.DisabledDate),
                
            // RetiredInventoryItemã®çŠ¶æ…‹é·ç§»
            (RetiredInventoryItem item, GoodsShipped e) => item with { 
                StockQuantity = item.StockQuantity - e.Quantity 
            },
            
            (RetiredInventoryItem item, OutgoingStockReserved e) => HandleRetiredOutgoingReservation(item, e),
            
            (RetiredInventoryItem item, ReservationCancelled e) => HandleRetiredReservationCancellation(item, e),
            
            (RetiredInventoryItem item, InventryItemDisabled e) => new DisabledInventoryItem(
                item.ProductId,
                item.WarehouseId,
                item.ProductName,
                item.StockQuantity,
                item.CreatedAt,
                e.DisabledDate),
                
            // ãã®ä»–ã®å ´åˆã¯ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ãã®ã¾ã¾è¿”ã™
            _ => payload
        };
        
    // è£œåŠ©ãƒ¡ã‚½ãƒƒãƒ‰ï¼šå…¥åº«äºˆç´„ã®å‡¦ç†
    private static ActiveInventoryItem HandleIncomingReservation(ActiveInventoryItem item, IncomingStockReserved e)
    {
        var updatedReservations = new Dictionary<Guid, ReservationInfo>(item.IncomingReservations);
        updatedReservations[e.ReservationId] = new ReservationInfo(e.ReservationId, e.Quantity, e.ReservationDate);
        
        return item with { IncomingReservations = updatedReservations };
    }
    
    // è£œåŠ©ãƒ¡ã‚½ãƒƒãƒ‰ï¼šå‡ºåº«äºˆç´„ã®å‡¦ç†
    private static ActiveInventoryItem HandleOutgoingReservation(ActiveInventoryItem item, OutgoingStockReserved e)
    {
        var updatedReservations = new Dictionary<Guid, ReservationInfo>(item.OutgoingReservations);
        updatedReservations[e.ReservationId] = new ReservationInfo(e.ReservationId, e.Quantity, e.ReservationDate);
        
        return item with { OutgoingReservations = updatedReservations };
    }
    
    // ä»–ã®è£œåŠ©ãƒ¡ã‚½ãƒƒãƒ‰ã‚‚åŒæ§˜ã«å®Ÿè£…
}
```

### 7. Queryå®Ÿè£…

```csharp
[GenerateSerializer]
public record InventoryItemListQuery(string? ProductIdFilter = null, string? WarehouseIdFilter = null)
    : IMultiProjectionListQuery<AggregateListProjector<InventoryItemProjector>, InventoryItemListQuery, InventoryItemListQuery.ResultRecord>
{
    public static ResultBox<IEnumerable<ResultRecord>> HandleFilter(
        MultiProjectionState<AggregateListProjector<InventoryItemProjector>> projection,
        InventoryItemListQuery query,
        IQueryContext context)
    {
        return projection.Payload.Aggregates
            .Where(m => m.Value.GetPayload() is ActiveInventoryItem || m.Value.GetPayload() is RetiredInventoryItem)
            .Select(m => {
                var payload = m.Value.GetPayload();
                
                if (payload is ActiveInventoryItem active)
                {
                    // ProductIdFilterãŒæŒ‡å®šã•ã‚Œã¦ã„ã¦ä¸€è‡´ã—ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                    if (query.ProductIdFilter != null && active.ProductId != query.ProductIdFilter)
                    {
                        return null;
                    }
                    
                    // WarehouseIdFilterãŒæŒ‡å®šã•ã‚Œã¦ã„ã¦ä¸€è‡´ã—ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                    if (query.WarehouseIdFilter != null && active.WarehouseId != query.WarehouseIdFilter)
                    {
                        return null;
                    }
                    
                    return new ResultRecord(
                        m.Value.PartitionKeys.AggregateId,
                        active.ProductId,
                        active.WarehouseId,
                        active.ProductName,
                        active.StockQuantity,
                        "Active",
                        active.IncomingReservations.Sum(r => r.Value.Quantity),
                        active.OutgoingReservations.Sum(r => r.Value.Quantity)
                    );
                }
                else if (payload is RetiredInventoryItem retired)
                {
                    // ProductIdFilterãŒæŒ‡å®šã•ã‚Œã¦ã„ã¦ä¸€è‡´ã—ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                    if (query.ProductIdFilter != null && retired.ProductId != query.ProductIdFilter)
                    {
                        return null;
                    }
                    
                    // WarehouseIdFilterãŒæŒ‡å®šã•ã‚Œã¦ã„ã¦ä¸€è‡´ã—ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                    if (query.WarehouseIdFilter != null && retired.WarehouseId != query.WarehouseIdFilter)
                    {
                        return null;
                    }
                    
                    return new ResultRecord(
                        m.Value.PartitionKeys.AggregateId,
                        retired.ProductId,
                        retired.WarehouseId,
                        retired.ProductName,
                        retired.StockQuantity,
                        "Retired",
                        0,
                        retired.OutgoingReservations.Sum(r => r.Value.Quantity)
                    );
                }
                
                return null;
            })
            .Where(r => r != null)
            .Select(r => r!)
            .ToResultBox();
    }

    public static ResultBox<IEnumerable<ResultRecord>> HandleSort(
        IEnumerable<ResultRecord> filteredList,
        InventoryItemListQuery query,
        IQueryContext context)
    {
        return filteredList
            .OrderBy(m => m.ProductId)
            .ThenBy(m => m.WarehouseId)
            .AsEnumerable()
            .ToResultBox();
    }

    [GenerateSerializer]
    public record ResultRecord(
        Guid Id,
        string ProductId,
        string WarehouseId,
        string ProductName,
        int StockQuantity,
        string Status,
        int TotalIncomingReservations,
        int TotalOutgoingReservations
    );
}
```

## å®Ÿè£…ã®æ³¨æ„ç‚¹

1. **åœ¨åº«æ•°ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**ï¼š
   - å‡ºåº«æ™‚ã«ã¯åœ¨åº«æ•°ãŒå‡ºåº«æ•°é‡ä»¥ä¸Šã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
   - å‡ºåº«äºˆç´„æ™‚ã«ã‚‚åŒæ§˜ã«äºˆç´„å¯èƒ½ãªåœ¨åº«ãŒååˆ†ã‚ã‚‹ã‹ç¢ºèª

2. **çŠ¶æ…‹é·ç§»ã®åˆ¶ç´„**ï¼š
   - `ActiveInventoryItem` â†’ `RetiredInventoryItem` ã¾ãŸã¯ `DisabledInventoryItem`
   - `RetiredInventoryItem` â†’ `DisabledInventoryItem`
   - é€†æ–¹å‘ã¸ã®é·ç§»ã¯ä¸å¯

3. **äºˆç´„ã®æ•´åˆæ€§**ï¼š
   - äºˆç´„ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã«ã¯ã€è©²å½“ã™ã‚‹äºˆç´„ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
   - å…¥åº«äºˆç´„ã¯ `ActiveInventoryItem` ã®ã¿ãŒå—ã‘ä»˜ã‘å¯èƒ½
   - å‡ºåº«äºˆç´„ã¯ `ActiveInventoryItem` ã¨ `RetiredInventoryItem` ãŒå—ã‘ä»˜ã‘å¯èƒ½

4. **ç•°å¸¸ç³»ã¸ã®å¯¾å¿œ**ï¼š
   - æ•°é‡ãŒè² æ•°ã«ãªã‚‹ã‚ˆã†ãªã‚³ãƒãƒ³ãƒ‰ã¯ã‚¨ãƒ©ãƒ¼
   - å­˜åœ¨ã—ãªã„äºˆç´„IDã«å¯¾ã™ã‚‹æ“ä½œã¯ã‚¨ãƒ©ãƒ¼
   - çŠ¶æ…‹ã«å¿œã˜ã¦è¨±å¯ã•ã‚Œã¦ã„ãªã„æ“ä½œã¯ã‚¨ãƒ©ãƒ¼

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. ä¸Šè¨˜ã®è¨ˆç”»ã«åŸºã¥ã„ã¦ã€å„ã‚¯ãƒ©ã‚¹ã®å®Ÿè£…ã‚’é€²ã‚ã¾ã™
2. å˜ä½“ãƒ†ã‚¹ãƒˆã‚’ä½œæˆã—ã€å„çŠ¶æ…‹é·ç§»ã¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ­£ã—ãæ©Ÿèƒ½ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™
3. APIå±¤ã‚’å®Ÿè£…ã—ã€RESTful APIã‚’é€šã˜ã¦å¤–éƒ¨ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ã—ã¾ã™

å€‰åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚·ãƒ³ã‚°ãƒ¢ãƒ‡ãƒ«ã¯ã€å…¥åº«ã€å‡ºåº«ã€äºˆç´„ã¨ã„ã†åŸºæœ¬æ“ä½œã¨ã€ãã‚Œã‚‰ã®çŠ¶æ…‹ç®¡ç†ã‚’æ­£ç¢ºã«å®Ÿè£…ã™ã‚‹ã“ã¨ãŒãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚ç‰¹ã«äºˆç´„ã®ç®¡ç†ã‚„çŠ¶æ…‹ã«å¿œã˜ãŸæ“ä½œåˆ¶é™ã‚’é©åˆ‡ã«å®Ÿè£…ã™ã‚‹ã“ã¨ã§ã€æ•´åˆæ€§ã®ã‚ã‚‹ã‚·ã‚¹ãƒ†ãƒ ãŒæ§‹ç¯‰ã§ãã‚‹ã§ã—ã‚‡ã†ã€‚ğŸ˜Š
